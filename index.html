
<!doctype html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>studio sensor </title>
<meta name="description" content="frog studio sensor project"/>
<meta name="author" content="joshua noble"/>
<link rel="stylesheet" href="foundation.css"/>
<script src="../assets/js/modernizr.js"></script>
</head>
<body>
 
<div class="row">
<div class="large-12 columns">
<div class="nav-bar right">
<ul class="button-group">
<li><a href="#assembly" class="button">Assembly</a></li>
<li><a href="#data" class="button">Getting Data</a></li>
<li><a href="#database" class="button">Setting up the Database</a></li>
<li><a href="#ec2" class="button">EC2</a></li>
<li><a href="#node" class="button">Node</a></li>
<li><a href="#troubleshooting" class="button">Troubleshooting the RPi</a></li>
</ul>
</div>
<h1>Studio Sensor</h1>
<p>All about the frog studio sensor</p>
<hr/>
</div>
</div>
 
 
<div class="row">
 
<div class="large-9 columns" role="content">

<article id="assembly">

<h2>I just got my sensor, what do I do?</h2>

<div class="row">
	<div class="large-12 columns caption">
	You need to get the MAC address of the Edimax-7811Un that came with your kit. You'll see it next to the thing that says MAC on the USB connection. 	<a href="images/IMG_2945.JPG"><img src="images/IMG_2945.JPG"/></a>
    Got it? Good. Now make a URL that looks like this: <p class="code">http://54.191.189.58:3000/set_studio_zone?mac=801f027e8c20&studio=SEA&zone=0</p> This is important that you get this right and that you do this before you assemble and plug in the sensor.
	<ul>
		<li><span class="code">mac=801f027e8c20</span> This needs to be the MAC address from your dongle. The sensor will use this to figure out what it is.</li>
		<li><span class="code">studio=SEA</span> This is your studio. It can only be 3 letters long.</li>
		<li><span class="code">zone=0</span> This is the zone that the sensor will be installed in. It can be 10 letters long.</li>
	</ul>
	<strong>Now go to your URL.</strong> If you get a 409 for some reason, that means that you've done something wrong or something has gone horribly wrong on EC2. Hopefully neither of those things will happen. This is so that the sensor knows what zone it is to be located in and how to log all of its data.
	</div>
</div>

<article id="assembly">

<h2>Assembling the Sensor Kit</h2>

<div class="row">
	<div class="large-6 columns caption">
	1. This is what you'll be getting.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2908.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	2. This is what you'll need: solder, a soldering iron, and a way to clean the soldering iron.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2909.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	3. Place the 13x2 header on *the bottom* of the board
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2910.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	4. Solder the 13x2 header in place
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2911.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	5. Clip female jumpers like so, you'll need jumpers with 2, 4, and 5 places.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2912.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	6. This is what they should look like.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2913.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	7. You'll also need a male jumper with 3 posts.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2914.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	8. Place them on the board like so.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2915.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	9. Here's another view.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2916.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	10. I use a piece of tape to hold them in place while soldering
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2917.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	11. All soldered up.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2918.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	12. Now place the 8pin DIP socket
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2919.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	13. Doesn't matter what direction it faces but it's easier you don't have it facing like I do here (it will matter what direction the chip faces).
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2920.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	15. Now place the MCP3002. The little dot faces towards the "S" on the board.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2921.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	16. Now place the light sensor.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2922.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	17. Now place the DHT22. Make sure it faces towards the MCP3002
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2923.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	18. Now attach the PIR sensor.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2924.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
	19. Now attach the PIR sensor.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2925.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		20. Now solder the right angle header onto the sound sensor.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2926.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		21. Voila!
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2927.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		23. Now attach the mic to the sensor kit.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2928.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		23. Now attach the mic to the sensor kit.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2929.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		24. All done.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2930.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		25. Soft focus.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2931.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		26. C'est ça.
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2933.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		27. Plug in the Wifi dongle
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2947.JPG"/>
	</div>
</div>

<div class="row">
	<div class="large-6 columns caption">
		28. Plug in the power
	</div>
	<div class="large-6 columns">
		<img src="images/IMG_2948.JPG"/>
	</div>
</div>

</article>

<hr/>


<article id="data">
<h2>Getting Data</h2>

Where's the visualization? Good question. Have you made one yet? No? Well there's your answer. This is meant to look different to each studio. There are a few basic pattern goes like so:

<p class="code">/view?params</p>

Let's look at some more stuff in here. You're probably going to want to just use the following:
<br/>
<strong>Reading by studio and time</strong>

<p class="code">URL:3000/view?studio=SEA&begindate=24032014&begintime=1600&enddate=24032014&endtime=1700</p>

That gives you all the data from Seattle from 24032014:1600 to 24032014:1700 thats DDMMYY:24HR. This will return something that looks like:

<p class="code">[{"id":134,"sensor_id":1,"time":"2014-03-24T23:48:55.442Z","light":1,"sound":114,"movement":1,"temp":18,"humidity":147,"brightness":0},
{"id":135,"sensor_id":1,"time":"2014-03-24T23:49:20.120Z","light":1347,"sound":562,"movement":0,"temp":34,"humidity":3,"brightness":0}]</p>

Whoa. That's JSON!
<br/>
The frog studio sensors log all their data up there to my server every 15 seconds.
<br/>
Ok, so we have a few things in there:
<br/>
<ul>
<li><em>sensor_id</em>: what sensor is it?</li>
<li><em>studio</em>: what studio is it in?</li>
<li><em>zone</em>: what part of the studio is it in?</li>
<li><em>time</em>: that's a timestamp (this is in GMT)</li>
<li><em>sound</em>: scale from 0-30 (afaict)</li>
<li><em>movement</em>: has anything moved in that zone in the last 30 seconds?</li>
<li><em>humidity</em>: what's the relative humidity (percent)</li>
<li><em>temperature</em>: Celsius</li>
<li><em>light</em>: light frequency in values from 480-600 (afaict)</li>
<li><em>brightness</em>: not being used right now</li>
</ul>
The raspberry pi just logs its data using a URL like:

http://OUR_URL:3000/?i=1&l=343&s=232&t=22&h=33&m=0&&studio=sea&zone=1

You can make fake (test) posts all you want.

There is more though, be warned though, these datasets can get massive and pulling them all is slow
<br/>
<strong>All studios by date:</strong>

<p class="code">URL:3000/view?begindate=24032014&begintime=1600&enddate=24032014&endtime=1700</p>

<strong>The last reading by zone</strong>

<p class="code">URL:3000/view?studio=SEA&zone=1&last=1</p>

<strong>All readings by zone</strong>

<p class="code">URL:3000/view?studio=SEA&zone=1</p>

<strong>All readings by sensorid (good for debugging)</strong>

<p class="code">URL:3000/view?id=1</p>

<strong>Timeboxed view of a particular zone:</strong>

<p class="code">URL:3000/?i=1&l=343&s=232&t=22&h=33&m=0&&studio=sea&zone=1</p>

<strong>All readings from the last hour</strong>

<p class="code">URL:3000/view?recent=1&zone=1&studio=SEA</p>

<strong>The last reading of a studio</strong>

<p class="code">URL:3000/view?now=1&studio=SEA</p>

Want more? It's very easy to add. Just take a look at <a href="https://github.com/joshuajnoble/studio-sensors/blob/master/server.js">server.js</a> for tips on how to make it better.


</article>



<hr/>
<article id="database">


<h2>DB INFO</h2>

Creating the DB is pretty simple:

<p class="code">create database sensordata;</p>

<p class="code">create table sensors ( studio varchar(3), zone varchar(10), id integer, constraint uid unique(id), ip varchar(16) );</p>

<p class="code">ALTER TABLE sensors ADD COLUMN key varchar(30);</p>

<p class="code">ALTER TABLE sensors ADD CONSTRAINT uniquekey UNIQUE (key);</p>

<p class="code">create table studio_zone ( studio varchar(3), zone varchar(10), mac varchar(12), constraint umac unique(mac) );</p>

<p class="code">create table readings ( id serial, sensor id int not null, time timestamp with time zone not null, light int not null, sound int not null, movement int not null, temp int not null, humidity int not null, brightness int not null, zone varchar(30) not null, studio varchar(30) not null);</p>

<p> So we wind up with this:
<br/>
<p class="code">public | readings    | table | postgres <br/>
public | sensors     | table | postgres <br/>
public | studio_zone | table | postgres <br/></p>

</p>

<p> <strong>Readings</strong> All readings (brightness isn't used)
<p class="code">
 id         | integer                  | not null default nextval('readings_id_seq'::regclass)<br/>
 sensor_id  | integer                  | not null<br/>
 time       | timestamp with time zone | not null<br/>
 light      | integer                  | not null<br/>
 sound      | integer                  | not null<br/>
 movement   | integer                  | not null<br/>
 temp       | integer                  | not null<br/>
 humidity   | integer                  | not null<br/>
 brightness | integer                  | not null<br/>
 zone       | character varying(30)    | not null<br/>
 studio     | character varying(30)    | not null<br/>
<p>
</p>

<p>
	<strong>Sensors</strong> Sensor to IP mappings (so you can ssh into the sensors)
<p class="code">
 studio | character varying(3)  | <br/>
 zone   | character varying(10) | <br/>
 id     | integer               | <br/>
 ip     | character varying(16) | <br/>
 key    | character varying(30) | <br/>
</p>

</p>

<p>
	<strong>studio_zone</strong> Studio to zone mappings
<p class="code">
	studio | character varying(3)  | <br/>
 zone   | character varying(10) | <br/>
 mac    | character varying(12) | <br/>
</p>
</p>

</article>

<hr/>

<article id="ec2">


<h2>Getting around on our EC2 instance</h2>

This is pretty easy, if I gave you a .pem then you're the boss! EC2 doesn't really care about passwords so sudo away (but don't ruin anything). To log in, do

<p class="code">ssh -i {WHEREVER}/AWS-JOSH.pem ubuntu@ec2-54-191-189-58.us-west-2.compute.amazonaws.com</p>

That gets you in. Once you're in you'll see a really stripped down setup:

<pre class="code">
ubuntu@ip-172-31-30-171:~$ ls
index.html  studio-sensors  tmp
</pre>

That's all that's in there on purpose. studio-sensors is the git repo. It's set up to use HTTP on purpose so that anybody can pull/push to the github repo without needing to mess with key setup.

<br/>

<strong>Upstart</strong>

We run the server on port 3000 using an upstart task. The task itself is super simple

<pre class="code">
description "node.js server"
author     "josh"

# used to be: start on startup
# until we found some mounts weren't ready yet while booting:
start on started mountall
stop on shutdown

# Automatically Respawn:
respawn
respawn limit 99 5

script
    # Not sure why $HOME is needed, but we found that it is:
    export HOME="/ubuntu"

    exec /usr/bin/nodejs /home/ubuntu/studio-sensors/server.js >> /var/log/node.log 2>&1
end script

post-start script
   # Optionally put a script here that will notifiy you node has (re)started
   # /root/bin/hoptoad.sh "node.js has started!"
end script
~          
</pre>

<p>It lives in the git repo but has to live in /etc/init to be recognized as a script. Starting it up: <span class="code">sudo start studioapi</span>. Shutting it up: <span class="code">sudo stop studioapi</span></p>

Feel free to alter it if needed but please keep the git version up to date. Thanks!

<strong>Postgres</strong>

You wanna do some Postgres? Wicked. Here you go:

<pre class="code">
ubuntu@ip-172-31-30-171:~$ sudo su postgres
postgres@ip-172-31-30-171:/home/ubuntu$ psql
psql (9.3.5)
Type "help" for help.

postgres=# \c studiosensors;
You are now connected to database "studiosensors" as user "postgres".
</pre>

Now you're in the database. You can do whatever you want from there, for example, get the last reading:

<pre class="code">
studiosensors=# select * from readings order by time desc limit 1;
 id  | sensor_id |             time              | light | sound | movement | temp | humidity | brightness | zone | studio 
-----+-----------+-------------------------------+-------+-------+----------+------+----------+------------+------+--------
 341 |         7 | 2014-11-21 01:26:00.375019+00 |   600 |    10 |        1 |   23 |       35 |          0 | 1    | SEA
(1 row)

</pre>

or

<pre class="code">
studiosensors=# select * from sensors;
 studio | zone | id |      ip      | key  
--------+------+----+--------------+------
 SEA    | 0    |  6 | 10.119.73.80 | SEA0
 SEA    | 1    |  7 | 10.119.73.80 | SEA1
</pre>

That's really all there is to it.

</article>

<hr/>

<article id="node">
	<h2>Node</h2>
	Ok, I know nothing about Node. Not going to lie. There's nothing cool in the server.js. I can lay it all out here really quick

	Connect to the server:
	<a href="https://github.com/joshuajnoble/studio-sensors/blob/master/server.js#L10"><pre class="code">
		var conString = "postgres://postgres:godzilla1@localhost:5432/studiosensors";
	</pre></a>

	Make the app listen on 3000:
	<a href="https://github.com/joshuajnoble/studio-sensors/blob/master/server.js#L29"><pre class="code">
		app.listen(3000);
	</pre></a>

	Handle *all* the routing:

<a href="https://github.com/joshuajnoble/studio-sensors/blob/master/server.js#L31-40"><pre class="code">
	function handler (req, res) {

	  req.on('error', function (err) {
	    console.log(" error? ");
	  });

	  var uri = url.parse(req.url).pathname;
	  var q = querystring.parse(url.parse(req.url).query);
	 
	  if(uri == '/') 
	  {
</pre></a>

	Here's what the insert looks like. Yeah, I know, insecure, sql injection, overflows, effed up, all that. Please fix it, thanks :)

<a href="https://github.com/joshuajnoble/studio-sensors/blob/master/server.js#L47-50"><pre class="code">
 var query = "INSERT INTO readings (sensor_id, studio, zone, time, light, sound, temp, movement, humidity, brightness) " +
			"VALUES (" + parseInt(q.i,10) + ","  + studioStr + "," + zoneStr + ",current_timestamp," 
			+ parseInt(q.l,10) + "," + parseInt(q.s,10) + "," + parseInt(q.t,10) + "," + 
			parseInt(q.m,10) + "," + parseInt(q.h,10) +",0);";

       console.log(query);
       client.query(query,  function(err, result) {
</pre></a>

The rest continues on in the same manner, parse routes, parse params, do the postgres query, return 200 on success and 409 on fail. The 409 is important because the Raspberry Pi knows that 409 = mistakes and logs accordingly. You'll see all the routes in that same "if/else if" pattern.

</article>

<hr/>

<article id="troubleshooting">

<h2>Troubleshooting</h2>

<p>
<strong>SSH into the RPi</strong>
<br/>
You can always SSH into the Pi if you're wondering what's up with it. To get the IP just call

<p class="code">http://54.191.189.58:3000/get_ip?studio=SEA&zone=0</p>

Then ssh in with pi@xxx.xxx.xxx.xxx and the password is, you know.

</p>

<p>
<strong>Can't get the Pi online?</strong>
<br/>
Try making a little entry in crontab to make the RaspberryPi ping your router every minute. This will ensure that your wifi connection will stay alive. To edit crontab just type (from pi user, you don’t need to be root):

<p class="code">crontab -e</p>

and insert this line at the end:

<p class="code">*/1 * * * * ping -c 1 192.168.0.1</p>

where 192.168.0.1 is the IP of your router. I don't know what your studios router address will be, so you'll have to figure that out.
<br/>
</p>
<p>
<strong>PIR Readings weird?</strong>
<br/>
Make sure it's facing somewhere that doesn't have a huge amount of fluctuation of light, i.e. pointing at a window or in a room with auto-switching lights. Make sure it's in a place where people are passing by it. 

<br/>
</p>
<p>
<strong>Kitchen</strong>
<br/>
Don't put the sensor too close to the sink or dishwasher or your temp/humidity readings will get very strange. 
</p>
</article>

</div>
 
<footer class="row">
<div class="large-12 columns">
<hr/>
<div class="row">
<div class="large-6 columns">
<p>joshua noble | frog seattle | 2014</p>
</div>
</ul>
</div>
</div>
</div>
</footer>
<script>
  document.write('<script src=js/vendor/' +
  ('__proto__' in {} ? 'zepto' : 'jquery') +
  '.js><\/script>')
  </script>
<script src="../../assets/js/jquery.js"></script>
<script src="js/foundation.min.js"></script>
<script>
    $(document).foundation();
  </script>
<script src="../assets/js/templates/jquery.js"></script>
<script src="../assets/js/templates/foundation.js"></script>
<script>
      $(document).foundation();

      var doc = document.documentElement;
      doc.setAttribute('data-useragent', navigator.userAgent);
    </script>
</body>
</html>